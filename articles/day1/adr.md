# Day 1: Выбор библиотеки WebSocket для Go

## Контекст и проблема

При проверке гипотезы о взаимодействии множества WebSocket-клиентов с сервисом необходимо было выбрать оптимальную библиотеку для реализации на Go. 

Основные требования:

- Поддержка десятков тысяч одновременных соединений
- Эффективное управление конкурентностью через горутины
- Низкие задержки при обработке кадров (frames)
- Поддержка сжатия данных (permessage-deflate, RFC 7692)
- Современный API с поддержкой Context
- Активная поддержка и развитие проекта
 
## Рассмотренные варианты

### 1. gorilla/websocket

Плюсы:

- Старый добрый стандарт с огромным комьюнити
- Стабильность и надёжность
- Богатая документация и примеры
- Поддержка permessage-deflate (без context takeover)

Минусы:

- API немного устарел (нет встроенной поддержки контекстов)
- Проект переведён в архивный статус (хотя критические правки вносятся)
- Традиционный callback-стиль
- Средняя производительность

### 2. gobwas/ws

Плюсы:

- Экстремальная производительность
- Низкий уровень, минимум аллокаций памяти
- Zero-copy архитектура
- Идеален для миллиона соединений

Минусы:

- Высокая сложность освоения
- Низкоуровневый API требует больше кода
- Нет нативной поддержки Context (нужно оборачивать вручную)
- Опциональная поддержка permessage-deflate

### 3. coder/websocket (ex-nhooyr/websocket)

Плюсы:

- Золотая середина между удобством и производительностью
- Идиоматичный Go-код
- Нативная поддержка Context
- Поддержка HTTP/2
- Активно поддерживается компанией Coder (передан под крыло в 2024)
- Современный API
- Полная поддержка permessage-deflate через отдельный пакет ws/wsflate

Минусы:

- Сжатие реализовано через отдельный пакет (не в ядре)
- Меньше примеров в интернете по сравнению с gorilla

### Сравнительная таблица

| Характеристика | Gorilla | Coder<br>(ex-nhooyr) | Gobwas | 
|:---|:---:|:---:|:---:| 
| Стиль API | Традиционный<br>(callbacks) | Современный<br>(Context) | Низкоуровневый<br>(Zero-copy) | 
| Производительность | Средняя | Высокая | Максимальная | 
| Поддержка Context | Нет | ✅ Да<br>(нативная) | Нет | 
| Статус проекта | В архиве | ✅ Активно | Активен | 
| Сложность освоения | Низкая | Низкая | Высокая | 
| permessage-deflate | Частичная | ✅ Полная | Опционально |

## Решение

Выбрана библиотека coder/websocket как золотая середина для новых проектов.

Обоснование:

1. Современный API с Context — критически важно для управления жизненным циклом соединений, таймаутами и graceful shutdown
2. Активная поддержка — проект передан компании Coder для долгосрочного развития
3. Высокая производительность — достаточна для большинства high-load сценариев
4. Идиоматичный Go-код — проще поддерживать и onboarding новых разработчиков
5. Полная поддержка сжатия — экономия трафика в 5-10 раз для текстовых данных

Для текущего прототипа использована gorilla/websocket:

Решение обусловлено:

- Достаточной функциональностью для эксперимента
- Наличием готовых примеров
- Стабильностью (архивный статус = заморожен, но не сломан)

## Последствия

### Положительные:

✅ Чистый, читаемый код с Context

✅ Простая интеграция с существующими HTTP-серверами

✅ Экономия трафика до 80% при включении сжатия

✅ Меньше утечек горутин благодаря нативной поддержке контекстов

✅ Долгосрочная поддержка от Coder

### Отрицательные:

⚠️ Сжатие создаёт нагрузку на CPU (рекомендуется уровень 1-2 вместо 9)

⚠️ Меньше готовых примеров в интернете по сравнению с gorilla

⚠️ Необходимость изучить дополнительный пакет wsflate для настройки сжатия

## Технические рекомендации:

- Всегда устанавливать SetWriteDeadline перед операциями записи
- Использовать SetReadLimit для защиты от DoS-атак
- Для текста/JSON: уровень сжатия 1 или 2 (баланс CPU/трафик)

## Метаданные

Статус: ✅ Принято

Дата создания: 09.02.2026

Последнее обновление: 09.02.2026

Репозиторий: github.com/arootcom/websocket

## Ссылки

- [coder/websocket на GitHub](https://github.com/coder/websocket)
- [RFC 7692 (permessage-deflate)](https://datatracker.ietf.org/doc/html/rfc7692)
- [Репозиторий проекта](https://github.com/arootcom/websocket)
